#!/usr/bin/env ruby
require 'rubygems'

require 'rfc5322.rb'
include Rfc5322

require 'maildir'
require 'yaml'
require 'trollop'

def process_account(account,config)
    begin
        client = Rfc5322.login(account,config)
    rescue
        puts "Could not authenticate #{account}"
        exit 1
    end
    account_config=config[:accounts][account]
    
    if account_config[:since_id] == nil
        account_config[:since_id] = 1 
    end
    timeline=client.statuses.home_timeline? :since_id => account_config[:since_id],:count => 200
    if timeline.length > 0 
        # maildir
        if account_config[:maildir]
            maildir = Maildir.new(account_config[:maildir])
            timeline.reverse.each do |tweet| maildir.add(Rfc5322.create_email(tweet,account)) end
        end

        # store id for latest message
        account_config[:since_id] = timeline[0].id
    end
end


# Main
opts = Trollop::options do
    opt :add_account, "Add account", :type => :string
end

begin
    config_file = "#{ENV['HOME']}/.rfc5322.yaml"
    config = YAML.load_file(config_file)
rescue
    unless opts[:add_account_given]
        puts "Could not find #{config_file}"
        exit 1
    end
    config = {}
end


if opts[:add_account_given]
    if config[:accounts] == nil
        config[:accounts] = {}
    end
    print "Maildir: "
    maildir = gets.strip
    config[:accounts][opts[:add_account].to_sym]={:maildir => maildir}
end

if  config == false or config[:accounts] == nil
    puts "No accounts in #{config_file}"
    exit 1
end

config[:accounts].keys.each do |account| process_account(account,config) end

begin
    File.open(config_file, "w") do |f| f.write(config.to_yaml) end
rescue
    puts "Could not update #{config_file}"
    exit 1
end
